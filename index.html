<script>
  const todayKey = new Date().toISOString().split('T')[0];
  let waterData = JSON.parse(localStorage.getItem('waterData')) || {};
  let dailyGoal = parseInt(localStorage.getItem('dailyGoal')) || 2800;
  if (!waterData[todayKey]) waterData[todayKey] = 0;
  let totalDrank = waterData[todayKey];
  let lastAddedAmount = 0;

  function setDailyGoal() {
    const goalInput = document.getElementById("goalInput");
    const newGoal = parseInt(goalInput.value);
    if (!isNaN(newGoal) && newGoal > 0) {
      dailyGoal = newGoal;
      localStorage.setItem('dailyGoal', dailyGoal);
      updateDisplay();
    } else {
      alert("LÃ¼tfen geÃ§erli bir gÃ¼nlÃ¼k hedef giriniz.");
    }
  }

  function addWater() {
    const input = document.getElementById("waterInput");
    const amount = parseInt(input.value);
    if (!isNaN(amount) && amount > 0) {
      totalDrank += amount;
      if (totalDrank > dailyGoal) totalDrank = dailyGoal;
      waterData[todayKey] = totalDrank;
      localStorage.setItem('waterData', JSON.stringify(waterData));
      lastAddedAmount = amount;
      document.getElementById("undoBtn").disabled = false;
      updateDisplay();
      updateHistory();
      updateChart();
      saveToGoogleSheet(amount); // ðŸ”„ Sheets'e gÃ¶nder
    } else {
      alert("LÃ¼tfen geÃ§erli bir miktar giriniz.");
    }
  }

  function undoWater() {
    if (lastAddedAmount > 0) {
      totalDrank -= lastAddedAmount;
      if (totalDrank < 0) totalDrank = 0;
      waterData[todayKey] = totalDrank;
      localStorage.setItem('waterData', JSON.stringify(waterData));
      lastAddedAmount = 0;
      document.getElementById("undoBtn").disabled = true;
      updateDisplay();
      updateHistory();
      updateChart();
    }
  }

  function updateDisplay() {
    const remaining = dailyGoal - totalDrank;
    const percent = (totalDrank / dailyGoal) * 100;
    document.getElementById("dailyGoalDisplay").textContent = dailyGoal;
    document.getElementById("totalDrank").textContent = totalDrank;
    const cups = (totalDrank / 180).toFixed(1);
    document.getElementById("totalCups").textContent = cups;
    document.getElementById("remaining").textContent = Math.max(0, remaining);
    document.getElementById("progressBar").style.width = percent + "%";
  }

  function updateHistory() {
    const historyList = document.getElementById("historyList");
    historyList.innerHTML = "";
    const dates = Object.keys(waterData).sort((a, b) => b.localeCompare(a));
    dates.forEach(date => {
      const li = document.createElement("li");
      li.textContent = `${date}: ${waterData[date]} ml`;
      historyList.appendChild(li);
    });
  }

  function updateChart() {
    const ctx = document.getElementById('historyChart').getContext('2d');
    const sortedDates = Object.keys(waterData).sort();
    const chartData = sortedDates.map(date => waterData[date]);
    const chartLabels = sortedDates.map(date => date.slice(5));

    if (window.historyChart) window.historyChart.destroy();
    window.historyChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: chartLabels,
        datasets: [{
          label: 'Ä°Ã§ilen Su (ml)',
          data: chartData,
          backgroundColor: '#4caf50'
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission !== 'granted') {
      Notification.requestPermission();
    }
  }

  function showNotification() {
    if (Notification.permission === 'granted') {
      new Notification('Su Ä°Ã§me ZamanÄ±!', {
        body: 'Bir bardak su iÃ§meyi unutma ðŸ’§',
      });
    }
  }

  // ðŸ”„ Google Sheets'e veri gÃ¶nderme
  function saveToGoogleSheet(amount) {
    const now = new Date();
    const data = {
      time: now.toLocaleString('tr-TR'),
      water: (amount / 1000).toFixed(2), // litre
    };

    fetch("https://script.google.com/macros/s/AKfycbxAIHN4kiQX4bgR2lk36flz9FVYx42Q1Q_5CsWmC2BdYoeXfEzQp-CyiNy-GaA50-0Y/exec", {
      method: "POST",
      mode: "no-cors",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(data)
    });
  }

  setInterval(showNotification, 1000 * 60 * 60 * 2); // 2 saatte bir bildirim

  updateDisplay();
  updateHistory();
  updateChart();
  requestNotificationPermission();
</script>
