<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Su Ä°Ã§me Takibi</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    .container {
      max-width: 400px;
      margin: auto;
    }
    input, button {
      margin: 10px;
      padding: 10px;
      font-size: 16px;
    }
    .progress {
      height: 30px;
      background-color: #e0e0e0;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 20px;
    }
    .progress-bar {
      height: 100%;
      background-color: #4caf50;
      width: 0%;
      transition: width 0.5s;
    }
    #history {
      margin-top: 30px;
      text-align: left;
    }
    canvas {
      margin-top: 30px;
      max-width: 100%;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Su Ä°Ã§me HatÄ±rlatÄ±cÄ±sÄ±</h1>
    <p>GÃ¼nlÃ¼k hedef: <span id="dailyGoalDisplay"></span> ml</p>
    <input type="number" id="goalInput" placeholder="GÃ¼nlÃ¼k hedef (ml)" />
    <button onclick="setDailyGoal()">Hedefi Kaydet</button>
    <br />
    <input type="number" id="waterInput" placeholder="Ä°Ã§tiÄŸin su (ml)" value="180" />
    <button onclick="addWater()">Ekle</button>
    <button onclick="undoWater()" id="undoBtn" disabled>Geri Al</button> <!-- Geri Al Butonu -->
    <p>Toplam iÃ§ilen: <span id="totalDrank">0</span> ml (<span id="totalCups">0</span> bardak)</p> <!-- Bardak sayÄ±sÄ± eklendi -->
    <p>Kalan: <span id="remaining">0</span> ml</p>
    <div class="progress">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <canvas id="historyChart"></canvas>

    <div id="history">
      <h3>GeÃ§miÅŸ GÃ¼nler</h3>
      <ul id="historyList"></ul>
    </div>
  </div>

  <script>
    const todayKey = new Date().toISOString().split('T')[0];
    let waterData = JSON.parse(localStorage.getItem('waterData')) || {};
    let dailyGoal = parseInt(localStorage.getItem('dailyGoal')) || 2800;
    if (!waterData[todayKey]) waterData[todayKey] = 0;
    let totalDrank = waterData[todayKey];

    // Geri al iÅŸlemi iÃ§in son eklenen miktar
    let lastAddedAmount = 0;

    function setDailyGoal() {
      const goalInput = document.getElementById("goalInput");
      const newGoal = parseInt(goalInput.value);
      if (!isNaN(newGoal) && newGoal > 0) {
        dailyGoal = newGoal;
        localStorage.setItem('dailyGoal', dailyGoal);
        updateDisplay();
      } else {
        alert("LÃ¼tfen geÃ§erli bir gÃ¼nlÃ¼k hedef giriniz.");
      }
    }

    function addWater() {
      const input = document.getElementById("waterInput");
      const amount = parseInt(input.value);
      if (!isNaN(amount) && amount > 0) {
        totalDrank += amount;
        if (totalDrank > dailyGoal) totalDrank = dailyGoal;
        waterData[todayKey] = totalDrank;
        localStorage.setItem('waterData', JSON.stringify(waterData));
        lastAddedAmount = amount;   // Son eklenen miktarÄ± sakla
        document.getElementById("undoBtn").disabled = false; // Geri al aktif
        updateDisplay();
        updateHistory();
        updateChart();
      } else {
        alert("LÃ¼tfen geÃ§erli bir miktar giriniz.");
      }
      // input.value = amount; // isteÄŸe baÄŸlÄ±, bÄ±rakabilirsin
    }

    function undoWater() {
      if (lastAddedAmount > 0) {
        totalDrank -= lastAddedAmount;
        if (totalDrank < 0) totalDrank = 0;
        waterData[todayKey] = totalDrank;
        localStorage.setItem('waterData', JSON.stringify(waterData));
        lastAddedAmount = 0;
        document.getElementById("undoBtn").disabled = true; // Geri al devre dÄ±ÅŸÄ±
        updateDisplay();
        updateHistory();
        updateChart();
      }
    }

    function updateDisplay() {
      const remaining = dailyGoal - totalDrank;
      const percent = (totalDrank / dailyGoal) * 100;
      document.getElementById("dailyGoalDisplay").textContent = dailyGoal;
      document.getElementById("totalDrank").textContent = totalDrank;

      // Bardak sayÄ±sÄ±nÄ± hesapla (1 bardak = 180 ml)
      const cups = (totalDrank / 180).toFixed(1);
      document.getElementById("totalCups").textContent = cups;

      document.getElementById("remaining").textContent = Math.max(0, remaining);
      document.getElementById("progressBar").style.width = percent + "%";
    }

    function updateHistory() {
      const historyList = document.getElementById("historyList");
      historyList.innerHTML = "";
      const dates = Object.keys(waterData).sort((a, b) => b.localeCompare(a));
      dates.forEach(date => {
        const li = document.createElement("li");
        li.textContent = `${date}: ${waterData[date]} ml`;
        historyList.appendChild(li);
      });
    }

    function updateChart() {
      const ctx = document.getElementById('historyChart').getContext('2d');
      const sortedDates = Object.keys(waterData).sort();
      const chartData = sortedDates.map(date => waterData[date]);
      const chartLabels = sortedDates.map(date => date.slice(5));

      if (window.historyChart) window.historyChart.destroy();
      window.historyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: chartLabels,
          datasets: [{
            label: 'Ä°Ã§ilen Su (ml)',
            data: chartData,
            backgroundColor: '#4caf50'
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission !== 'granted') {
        Notification.requestPermission();
      }
    }

    function showNotification() {
      if (Notification.permission === 'granted') {
        new Notification('Su Ä°Ã§me ZamanÄ±!', {
          body: 'Bir bardak su iÃ§meyi unutma ðŸ’§',
        });
      }
    }

    setInterval(showNotification, 1000 * 60 * 60 * 2); // 2 saatte bir bildirim

    // Ä°lk yÃ¼kleme
    updateDisplay();
    updateHistory();
    updateChart();
    requestNotificationPermission();
  </script>
</body>
</html>
